<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Golang on<hanC/></title><link>https://dangpangch.github.io/tags/golang/</link><description>Recent content in Golang on<hanC/></description><generator>Hugo</generator><language>zh-cn</language><lastBuildDate>Mon, 15 Sep 2025 15:29:25 +0800</lastBuildDate><atom:link href="https://dangpangch.github.io/tags/golang/rss.xml" rel="self" type="application/rss+xml"/><item><title>Golang/Context</title><link>https://dangpangch.github.io/posts/golang/context/</link><pubDate>Mon, 15 Sep 2025 15:29:25 +0800</pubDate><guid>https://dangpangch.github.io/posts/golang/context/</guid><description>&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Context&lt;/code&gt; 是&lt;strong&gt;Go&lt;/strong&gt;语言于&lt;strong&gt;v1.7&lt;/strong&gt;引入，用于在&lt;code&gt;goroutine&lt;/code&gt;中传递截止时间、取消信号和其他请求范围值的标准库，也是Go语言的一个特殊机制.&lt;/p&gt;&lt;/blockquote&gt;
&lt;h2 id="为什么需要-context-"&gt;为什么需要 Context ？&lt;/h2&gt;
&lt;p&gt;在经典的网络服务器中，每个传入的请求都在一个单独的&lt;code&gt;goroutine&lt;/code&gt;中处理，这里处理过程可能涉及到多个下游调用，例如访问数据库、调用 RPC 服务等，这时会面临几个问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;请求取消&lt;/strong&gt;：如果客户端连接关闭或者请求超时，那么需要关闭所有相关的 &lt;code&gt;goroutine&lt;/code&gt; ，避免资源浪费.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;超时控制&lt;/strong&gt;：某些操作需要明确的执行时间，超过该时间该停止，并返回超时错误.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;数据传递&lt;/strong&gt;：在整个请求链中，共享一些数据（例如：user_id, trace_id&amp;hellip;），需要一种安全的方式将共享的数据传递到各个函数，同时不污染函数签名.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;code&gt;context.Context&lt;/code&gt; 正是为了优雅解决这些问题，提供了一个在 API 边界之间和 &lt;code&gt;goroutine&lt;/code&gt; 之间传递“元数据”的标准方式.&lt;/p&gt;
&lt;h2 id="context-的核心原理"&gt;Context 的核心原理&lt;/h2&gt;
&lt;h3 id="context-接口"&gt;Context 接口&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;context&lt;/code&gt; 包的核心是 &lt;code&gt;Context&lt;/code&gt; 接口，它定义了四个方法：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;type&lt;/span&gt; &lt;span style="color:#e06c75"&gt;Context&lt;/span&gt; &lt;span style="color:#c678dd"&gt;interface&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// Deadline 返回一个时间点，当到达该时间点后，Context 将被自动取消。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// 如果没有设置 Deadline，ok 将返回 false。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#61afef;font-weight:bold"&gt;Deadline&lt;/span&gt;() (&lt;span style="color:#e06c75"&gt;deadline&lt;/span&gt; &lt;span style="color:#e06c75"&gt;time&lt;/span&gt;.&lt;span style="color:#e06c75"&gt;Time&lt;/span&gt;, &lt;span style="color:#e06c75"&gt;ok&lt;/span&gt; &lt;span style="color:#e5c07b"&gt;bool&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// Done 返回一个 channel。当 Context 被取消或超时时，该 channel 会被关闭。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// 如果 Context 不可取消，Done() 可能返回 nil。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#61afef;font-weight:bold"&gt;Done&lt;/span&gt;() &lt;span style="color:#56b6c2"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#c678dd"&gt;chan&lt;/span&gt; &lt;span style="color:#c678dd"&gt;struct&lt;/span&gt;{}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// Err 在 Done() channel 关闭后，返回 Context 被取消的原因。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// 如果 Context 未被取消，返回 nil。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// 常见原因为 context.Canceled 和 context.DeadlineExceeded。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#61afef;font-weight:bold"&gt;Err&lt;/span&gt;() &lt;span style="color:#e5c07b"&gt;error&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// Value 返回与该 Context 关联的键（key）对应的值（value）。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#7f848e"&gt;// 主要用于在请求处理链中传递请求范围的数据。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#61afef;font-weight:bold"&gt;Value&lt;/span&gt;(&lt;span style="color:#e06c75"&gt;key&lt;/span&gt; &lt;span style="color:#e5c07b"&gt;any&lt;/span&gt;) &lt;span style="color:#e5c07b"&gt;any&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="context-树状结构和传播机制"&gt;Context 树状结构和传播机制&lt;/h3&gt;
&lt;p&gt;Go 中的 &lt;code&gt;Context&lt;/code&gt; 具有&lt;strong&gt;继承关系&lt;/strong&gt;，可以形成一棵树状结构。当你基于一个父 &lt;code&gt;Context&lt;/code&gt; 创建一个子 &lt;code&gt;Context&lt;/code&gt; 时，它们之间就建立了关联.&lt;/p&gt;</description></item></channel></rss>